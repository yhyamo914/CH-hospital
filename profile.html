<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ | Ù…ØªØ¬Ø± Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>


<style>
/* ===== Ø¹Ø§Ù… ===== */
:root {
    --primary:#4361ee;
    --accent:#4cc9f0;
    --bg:#f4f6f9;
    --text:#333;
    --card-bg:#fff;
    --status-pending:#ffe066;
    --status-accepted:#51cf66;
    --status-rejected:#ff6b6b;
    --status-delivered:#4cc9f0;
}

[data-theme="dark"]{
    --bg:#121212;
    --text:#eee;
    --card-bg:#1f1f1f;
}

body{
    font-family:'Segoe UI', Tahoma;
    background:var(--bg);
    color:var(--text);
    margin:0;
    padding-bottom:80px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ */
    transition:0.3s;
}
.container{
    max-width:900px;
    margin:20px auto;
    padding:10px;
}
.card{
    background:var(--card-bg);
    border-radius:12px;
    padding:15px;
    box-shadow:0 10px 25px rgba(0,0,0,0.1);
    margin-bottom:20px;
}
h2{
    margin-bottom:10px;
    color:var(--primary);
    font-size:18px;
}
.info p{
    margin:6px 0;
    font-size:14px;
}
.info i{
    color:var(--primary);
    margin-left:8px;
}
.status{
    padding:4px 10px;
    border-radius:20px;
    font-size:12px;
    font-weight:600;
    display:inline-block;
}
.pending{ background:var(--status-pending); }
.accepted{ background:var(--status-accepted); color:white; }
.rejected{ background:var(--status-rejected); color:white; }
.delivered{ background:var(--status-delivered); color:white; }

.top-actions{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:15px;
    flex-wrap:wrap;
    gap:5px;
}
.btn{
    background:var(--primary);
    color:white;
    padding:8px 14px;
    border-radius:8px;
    text-decoration:none;
    font-weight:600;
    font-size:14px;
}
.btn:hover{
    background:var(--accent);
}

/* ===== Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø·Ù„Ø¨ ===== */
.order-item{
    display:flex;
    align-items:center;
    gap:5px;
    margin-bottom:3px;
}
.order-item img{
    width:30px;
    height:30px;
    object-fit:cover;
    border-radius:4px;
}

/* ===== Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„ÙƒØ¨ÙŠØ±Ø© ===== */
table{
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
    font-size:13px;
}
table th, table td{
    padding:8px;
    border-bottom:1px solid #ddd;
    text-align:center;
    vertical-align: middle;
}
table th{
    background:var(--primary);
    color:white;
    font-size:14px;
}

/* ===== Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ===== */
.mobile-card{
    display:none;
    background:#f9f9f9;
    border-radius:10px;
    padding:10px;
    margin-bottom:10px;
    box-shadow:0 2px 6px rgba(0,0,0,0.1);
}
[data-theme="dark"] .mobile-card{
    background:#1f1f1f;
}
.mobile-card h4{
    margin:0 0 5px 0;
    font-size:14px;
    color:var(--primary);
}
.mobile-card p{
    margin:2px 0;
    font-size:13px;
}

/* ===== Bottom Nav ===== */
.bottom-nav{
    display:flex;
    position:fixed;
    bottom:0;
    width:100%;
    background:var(--card-bg);
    justify-content:space-around;
    padding:6px 0;
    box-shadow:0 -2px 12px rgba(0,0,0,.1);
    z-index:1000;
}
.bottom-nav a{
    text-decoration:none;
    color:var(--text);
    font-size:24px;
    display:flex;
    flex-direction:column;
    align-items:center;
    position:relative;
}
.bottom-nav a i{
    font-size:16px;
}
.cart-badge{
    position:absolute;
    top:0;
    right:10px;
    background:red;
    color:#fff;
    font-size:10px;
    padding:1px 5px;
    border-radius:50%;
    display:none;
}

/* ===== Responsive ===== */
@media(max-width:768px){
    table{display:none;}
    .mobile-card{display:block;}
}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>

<div class="container">

    <div class="top-actions">
        <h2>ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h2>
        <div style="display:flex;gap:5px;">
            <a href="index.html" class="btn"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            <button id="logoutBtn" class="btn"><i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

    <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
    <div class="card info">
        <div style="text-align:center;margin-bottom:10px;">
    <img id="profileImage"
         src="https://via.placeholder.com/120"
         style="width:120px;height:120px;border-radius:50%;object-fit:cover;border:3px solid var(--primary);">

    <br><br>
    <label class="btn" style="cursor:pointer;">
        <i class="fas fa-camera"></i> ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©
        <input type="file" id="imageInput" accept="image/*" hidden>
    </label>
</div>

        <h2>ğŸ“„ Ø¨ÙŠØ§Ù†Ø§ØªÙŠ</h2>
        <p><i class="fas fa-user"></i> Ø§Ù„Ø§Ø³Ù…: <span id="userName">â€”</span></p>
        <p><i class="fas fa-envelope"></i> Ø§Ù„Ø¨Ø±ÙŠØ¯: <span id="userEmail">â€”</span></p>
    </div>

    <!-- Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª -->
    <div class="card">
        <h2>ğŸ“… Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</h2>
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø§Ù„ÙˆÙ‚Øª</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                </tr>
            </thead>
            <tbody id="appointmentsTable">
                <tr><td colspan="3">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
            </tbody>
        </table>
        <div id="appointmentsMobile" class="mobile-cards"></div>
    </div>

    <!-- Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© -->
    <div class="card">
        <h2>ğŸ›’ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h2>
        <table>
            <thead>
                <tr>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                    <th>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</th>
                    <th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙƒÙ„ÙŠ</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                </tr>
            </thead>
            <tbody id="ordersTable">
                <tr><td colspan="4">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
            </tbody>
        </table>
        <div id="ordersMobile" class="mobile-cards"></div>
    </div>

</div>

<!-- Bottom Navigation -->
<div class="bottom-nav">
  <a href="index.html"><i class="fas fa-home"></i><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></a>
  <a href="products.html"><i class="fas fa-laptop"></i><span>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span></a>
  <a href="cart.html"><i class="fas fa-shopping-cart"></i><span>Ø§Ù„Ø¹Ø±Ø¨Ø©</span><span id="cartCount" class="cart-badge">0</span></a>
  <a href="appointment.html"><i class="fas fa-calendar"></i><span>Ù…ÙˆØ¹Ø¯</span></a>
  <a href="profile.html" id="profileNav"><i class="fas fa-user"></i><span>Ø­Ø³Ø§Ø¨ÙŠ</span></a>
  <a href="admin.html" id="adminNav" style="display:none"><i class="fas fa-cogs"></i><span>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span></a>
</div>

<script>
    
const firebaseConfig = {
    apiKey: "AIzaSyCxZZ4dYqrxJ_rlMcXmZhx5Kwg_ZeYnYog",
    authDomain: "computer-store-4c946.firebaseapp.com",
    projectId: "computer-store-4c946"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

const userName = document.getElementById('userName');
const userEmail = document.getElementById('userEmail');
const appointmentsTable = document.getElementById('appointmentsTable');
const ordersTable = document.getElementById('ordersTable');
const appointmentsMobile = document.getElementById('appointmentsMobile');
const ordersMobile = document.getElementById('ordersMobile');

const profileNav = document.getElementById('profileNav');
const adminNav = document.getElementById('adminNav');
const cartCount = document.getElementById('cartCount');
const logoutBtn = document.getElementById('logoutBtn');

function updateCartCount(){
    const cart = JSON.parse(localStorage.getItem('cart')) || {};
    let total=0;
    Object.values(cart).forEach(item=>{ total+=item.quantity; });
    if(total>0){
        cartCount.style.display="block";
        cartCount.textContent=total;
    } else {
        cartCount.style.display="none";
    }
}

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
logoutBtn.addEventListener('click',()=>{
    auth.signOut().then(()=>{
        location.href="login.html";
    });
});

auth.onAuthStateChanged(user=>{
    if(!user){
        location.href="login.html";
        return;
    }

    userEmail.textContent = user.email;

    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    db.collection('users').doc(user.uid).get().then(doc=>{
        if(doc.exists){
            userName.textContent = doc.data().name || "â€”";
            if(doc.data().role==="admin"){
                adminNav.style.display="flex";
            }
        }
    });

    // Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª
    db.collection('appointments')
      .where('userId','==',user.uid)
      .onSnapshot(snapshot=>{
          appointmentsTable.innerHTML = '';
          appointmentsMobile.innerHTML = '';
          if(snapshot.empty){
              appointmentsTable.innerHTML = '<tr><td colspan="3">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª</td></tr>';
              appointmentsMobile.innerHTML = '<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª</p>';
              return;
          }
          snapshot.forEach(doc=>{
              const a = doc.data();
              let cls='pending', txt='Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±';
              if(a.status==='accepted'){ cls='accepted'; txt='Ù…Ù‚Ø¨ÙˆÙ„'; }
              if(a.status==='rejected'){ cls='rejected'; txt='Ù…Ø±ÙÙˆØ¶'; }

              appointmentsTable.innerHTML += `
                <tr>
                    <td>${a.date || 'â€”'}</td>
                    <td>${a.time || 'â€”'}</td>
                    <td><span class="status ${cls}">${txt}</span></td>
                </tr>
              `;

              appointmentsMobile.innerHTML += `
                <div class="mobile-card">
                    <h4>${a.date || 'â€”'}</h4>
                    <p>Ø§Ù„ÙˆÙ‚Øª: ${a.time || 'â€”'}</p>
                    <p>Ø§Ù„Ø­Ø§Ù„Ø©: <span class="status ${cls}">${txt}</span></p>
                </div>
              `;
          });
      });

    // Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    db.collection('orders')
      .where('email','==',user.email)
      .orderBy('createdAt','desc')
      .onSnapshot(snapshot=>{
          ordersTable.innerHTML = '';
          ordersMobile.innerHTML = '';
          if(snapshot.empty){
              ordersTable.innerHTML = '<tr><td colspan="4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td></tr>';
              ordersMobile.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>';
              return;
          }

          snapshot.forEach(doc=>{
              const o = doc.data();
              let cls='pending', txt='Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„';
              if(o.status==='delivered'){ cls='delivered'; txt='ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„'; }
              else if(o.status==='rejected'){ cls='rejected'; txt='Ù…Ù„ØºØ§Ø©'; }

              let productsList = '';
              let productsListMobile = '';
              if(o.items && o.items.length>0){
                  o.items.forEach(item=>{
                      productsList += `
                        <div class="order-item">
                            <img src="${item.image || 'https://via.placeholder.com/40'}">
                            <span>${item.name} (${item.qty})</span>
                        </div>
                      `;
                      productsListMobile += `${item.name} (${item.qty}), `;
                  });
                  productsListMobile = productsListMobile.slice(0,-2);
              } else productsList = 'â€”';

              ordersTable.innerHTML += `
                <tr>
                    <td>${doc.id}</td>
                    <td>${productsList}</td>
                    <td>${o.total || 0} Ø¬.Ù…</td>
                    <td><span class="status ${cls}">${txt}</span></td>
                </tr>
              `;

              ordersMobile.innerHTML += `
                <div class="mobile-card">
                    <h4>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${doc.id}</h4>
                    <p>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${productsListMobile || 'â€”'}</p>
                    <p>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙƒÙ„ÙŠ: ${o.total || 0} Ø¬.Ù…</p>
                    <p>Ø§Ù„Ø­Ø§Ù„Ø©: <span class="status ${cls}">${txt}</span></p>
                </div>
              `;
          });
      });

    updateCartCount();
});

// Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ
const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
</script>
<script>
// ===== Cloudinary Profile Image Upload =====
const profileImage = document.getElementById('profileImage');
const imageInput = document.getElementById('imageInput');

// Ø¨ÙŠØ§Ù†Ø§Øª Cloudinary
const CLOUD_NAME = "daliphjqw";
const UPLOAD_PRESET = "imagess";

auth.onAuthStateChanged(user=>{
    if(!user) return;

    // ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù† ÙˆØ¬Ø¯Øª
    db.collection('users').doc(user.uid).get().then(doc=>{
        if(doc.exists && doc.data().photoURL){
            profileImage.src = doc.data().photoURL;
        }
    });

    // Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©
    imageInput.addEventListener('change', async ()=>{
        const file = imageInput.files[0];
        if(!file) return;

        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", UPLOAD_PRESET);
        formData.append("folder", "profiles");

        try{
            const res = await fetch(
                `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,
                { method:"POST", body:formData }
            );
            const data = await res.json();

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
            profileImage.src = data.secure_url;

            // Ø­ÙØ¸ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Firestore
            await db.collection('users').doc(user.uid).set({
                photoURL: data.secure_url
            }, { merge:true });

        }catch(err){
            alert("ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©");
            console.error(err);
        }
    });
});
</script>


</body>
</html>
